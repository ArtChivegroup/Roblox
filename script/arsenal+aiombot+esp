-- SERVICES (Key System)
local HttpService = game:GetService("HttpService")
local PlayersService = game:GetService("Players") -- Renamed to avoid conflict later
local UserInputServiceKey = game:GetService("UserInputService") -- Renamed
local StarterGui = game:GetService("StarterGui")
local CoreGui = game:GetService("CoreGui")

local LocalPlayerKey = PlayersService.LocalPlayer -- Renamed

-- CONFIG
local keyURL = "https://raw.githubusercontent.com/ArtChivegroup/Jinx/main/Jinx/files/Sync"
local getKeyPage = "https://bloxhub.work.gd/keyblox.html"

-- VARIABLES
local validKey = nil
local uiVisible = true
local KeySystemScreenGui = nil -- Reference to the key system UI

-- FORWARD DECLARATION for the Arsenal script function
local runArsenalScript

-- FUNCTIONS (Key System)
local function fetchKey()
    local success, response = pcall(function()
        return game:HttpGet(keyURL)
    end)
    if success then
        return string.match(response, "%S+")
    else
        warn("Failed to fetch key!")
        return nil
    end
end

local function createKeySystemUI()
    KeySystemScreenGui = Instance.new("ScreenGui", CoreGui)
    KeySystemScreenGui.Name = "BloxHubKeySystem"
    KeySystemScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling -- Ensure it's on top

    local Frame = Instance.new("Frame", KeySystemScreenGui)
    Frame.Size = UDim2.new(0, 350, 0, 250)
    Frame.Position = UDim2.new(0.5, -175, 0.5, -125)
    Frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    Frame.BorderSizePixel = 0
    Frame.Active = true
    Frame.Draggable = true
    Frame.BackgroundTransparency = 0.1

    local UICorner = Instance.new("UICorner", Frame)
    UICorner.CornerRadius = UDim.new(0, 10)

    local Title = Instance.new("TextLabel", Frame)
    Title.Size = UDim2.new(1, 0, 0, 50)
    Title.BackgroundTransparency = 1
    Title.Text = "üîë BloxHub Key System"
    Title.TextColor3 = Color3.fromRGB(255, 255, 255)
    Title.Font = Enum.Font.GothamBold
    Title.TextSize = 22

    local Note = Instance.new("TextLabel", Frame)
    Note.Size = UDim2.new(1, -20, 0, 20)
    Note.Position = UDim2.new(0, 10, 0, 50)
    Note.BackgroundTransparency = 1
    Note.Text = "üîÑ The key changes every 1 hour." -- MODIFIED
    Note.TextColor3 = Color3.fromRGB(200, 200, 200)
    Note.Font = Enum.Font.Gotham
    Note.TextSize = 14
    Note.TextXAlignment = Enum.TextXAlignment.Left

    local KeyBox = Instance.new("TextBox", Frame)
    KeyBox.Size = UDim2.new(0.8, 0, 0, 40)
    KeyBox.Position = UDim2.new(0.1, 0, 0.35, 0)
    KeyBox.PlaceholderText = "Enter Key..."
    KeyBox.Text = ""
    KeyBox.TextSize = 18
    KeyBox.TextColor3 = Color3.fromRGB(0, 0, 0)
    KeyBox.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    KeyBox.ClearTextOnFocus = false

    local UICornerKey = Instance.new("UICorner", KeyBox)
    UICornerKey.CornerRadius = UDim.new(0, 5)

    local Submit = Instance.new("TextButton", Frame)
    Submit.Size = UDim2.new(0.8, 0, 0, 40)
    Submit.Position = UDim2.new(0.1, 0, 0.58, 0)
    Submit.Text = "‚úÖ Submit Key"
    Submit.TextSize = 18
    Submit.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
    Submit.TextColor3 = Color3.fromRGB(255, 255, 255)

    local UICornerSubmit = Instance.new("UICorner", Submit)
    UICornerSubmit.CornerRadius = UDim.new(0, 5)

    local GetKeyBrowser = Instance.new("TextButton", Frame)
    GetKeyBrowser.Size = UDim2.new(0.35, 0, 0, 30)
    GetKeyBrowser.Position = UDim2.new(0.1, 0, 0.82, 0)
    GetKeyBrowser.Text = "üåê Open in Browser"
    GetKeyBrowser.TextSize = 14
    GetKeyBrowser.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    GetKeyBrowser.TextColor3 = Color3.fromRGB(255, 255, 255)

    local UICornerBrowser = Instance.new("UICorner", GetKeyBrowser)
    UICornerBrowser.CornerRadius = UDim.new(0, 5)

    local GetKeyClipboard = Instance.new("TextButton", Frame)
    GetKeyClipboard.Size = UDim2.new(0.35, 0, 0, 30)
    GetKeyClipboard.Position = UDim2.new(0.55, 0, 0.82, 0)
    GetKeyClipboard.Text = "üìã Copy to Clipboard"
    GetKeyClipboard.TextSize = 14
    GetKeyClipboard.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    GetKeyClipboard.TextColor3 = Color3.fromRGB(255, 255, 255)

    local UICornerClipboard = Instance.new("UICorner", GetKeyClipboard)
    UICornerClipboard.CornerRadius = UDim.new(0, 5)

    local Minimize = Instance.new("TextButton", Frame)
    Minimize.Size = UDim2.new(0, 25, 0, 25)
    Minimize.Position = UDim2.new(1, -60, 0, 10)
    Minimize.Text = "-"
    Minimize.TextSize = 18
    Minimize.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
    Minimize.TextColor3 = Color3.fromRGB(255, 255, 255)

    local Exit = Instance.new("TextButton", Frame)
    Exit.Size = UDim2.new(0, 25, 0, 25)
    Exit.Position = UDim2.new(1, -30, 0, 10)
    Exit.Text = "X"
    Exit.TextSize = 18
    Exit.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    Exit.TextColor3 = Color3.fromRGB(255, 255, 255)

    -- Minimize / Expand
    Minimize.MouseButton1Click:Connect(function()
        uiVisible = not uiVisible
        Frame.Visible = uiVisible
    end)

    -- Exit UI
    Exit.MouseButton1Click:Connect(function()
        if KeySystemScreenGui then
            KeySystemScreenGui:Destroy()
        end
    end)

    -- Open key page in browser
    GetKeyBrowser.MouseButton1Click:Connect(function()
        StarterGui:SetCore("SendNotification", {
            Title = "BloxHub Key System",
            Text = "Opening key page in browser...",
            Duration = 5
        })

        if syn and syn.request then
            syn.request({Url = getKeyPage, Method = "GET"})
        elseif typeof(KRNL_LOADED) ~= "nil" and KRNL_LOADED.OpenURL then -- KRNL check
             KRNL_LOADED:OpenURL(getKeyPage)
        elseif getgenv().http_request then
            getgenv().http_request({Url = getKeyPage, Method = "GET"})
        elseif request then
            request({Url = getKeyPage, Method = "GET"})
        else
            setclipboard(getKeyPage)
            StarterGui:SetCore("SendNotification", {
                Title = "BloxHub Key System",
                Text = "Browser not supported. Link copied to clipboard!",
                Duration = 5
            })
        end
    end)

    -- Copy key link to clipboard
    GetKeyClipboard.MouseButton1Click:Connect(function()
        setclipboard(getKeyPage)
        StarterGui:SetCore("SendNotification", {
            Title = "BloxHub Key System",
            Text = "Link copied to clipboard!",
            Duration = 5
        })
    end)

    -- Submit key
    Submit.MouseButton1Click:Connect(function()
        local inputKey = KeyBox.Text
        local currentKey = fetchKey()
        if inputKey == currentKey then
            StarterGui:SetCore("SendNotification", {
                Title = "BloxHub Key System",
                Text = "‚úÖ Key Verified!",
                Duration = 3
            })
            wait(1)
            if KeySystemScreenGui then
                KeySystemScreenGui:Destroy()
                KeySystemScreenGui = nil -- Clear reference
            end
            -- ‚úÖ EXECUTE THE ARSENAL SCRIPT
            if runArsenalScript then
                runArsenalScript()
            else
                warn("Arsenal script function (runArsenalScript) not found!")
            end
        else
            StarterGui:SetCore("SendNotification", {
                Title = "BloxHub Key System",
                Text = "‚ùå Invalid Key!",
                Duration = 3
            })
        end
    end)
end

    -- Services
    local Players = game:GetService("Players")
    local RunService = game:GetService("RunService")
    local UserInputService = game:GetService("UserInputService")
    -- CoreGui is already defined globally by key system, but can be redefined locally if needed.
    -- local CoreGui = game:GetService("CoreGui") 
    
    local Camera = workspace.CurrentCamera
    local LocalPlayer = Players.LocalPlayer
    local Mouse = LocalPlayer:GetMouse()

    -- State
    local ESPEnabled = true
    local AimbotEnabled = false
    local FOVRadius = 240         -- default FOV
    local TeamCheck = false
    local AutoSnap = true
    local MaxDetectionDistance = 120 -- default
    local isMinimized = false
    local isActive = true -- For the main loop of Arsenal script

    -- GUI
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "ESP_Aimbot_GUI"
    screenGui.Parent = CoreGui
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

    -- Main Frame
    local mainFrame = Instance.new("Frame", screenGui)
    mainFrame.Size = UDim2.new(0, 200, 0, 410)
    mainFrame.Position = UDim2.new(0, 20, 0, 20)
    mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    mainFrame.BorderSizePixel = 0
    mainFrame.Draggable = true
    mainFrame.Active = true
    local mainFrameCorner = Instance.new("UICorner", mainFrame)
    mainFrameCorner.CornerRadius = UDim.new(0, 8)

    local titleLabel = Instance.new("TextLabel", mainFrame)
    titleLabel.Size = UDim2.new(1, 0, 0, 30)
    titleLabel.Position = UDim2.new(0, 0, 0, 0)
    titleLabel.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    titleLabel.Text = "Ultimate GUI V11 by BloxHub" -- MODIFIED
    titleLabel.TextColor3 = Color3.fromRGB(0, 170, 250)
    titleLabel.Font = Enum.Font.SourceSansBold
    titleLabel.TextSize = 16 -- Adjusted for longer text
    local titleCorner = Instance.new("UICorner", titleLabel)
    titleCorner.CornerRadius = UDim.new(0,8)

    -- Minimize & Exit
    local minimizeButton = Instance.new("TextButton", mainFrame)
    minimizeButton.Size = UDim2.new(0, 25, 0, 25)
    minimizeButton.Position = UDim2.new(1, -60, 0, 3)
    minimizeButton.Text = "_"
    minimizeButton.Font = Enum.Font.SourceSansBold
    minimizeButton.TextSize = 20
    minimizeButton.TextColor3 = Color3.fromRGB(220, 220, 220)
    minimizeButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    local minimizeCorner = Instance.new("UICorner", minimizeButton)
    minimizeCorner.CornerRadius = UDim.new(0, 4)

    local exitButton = Instance.new("TextButton", mainFrame)
    exitButton.Size = UDim2.new(0, 25, 0, 25)
    exitButton.Position = UDim2.new(1, -30, 0, 3)
    exitButton.Text = "X"
    exitButton.Font = Enum.Font.SourceSansBold
    exitButton.TextSize = 20
    exitButton.TextColor3 = Color3.fromRGB(220, 220, 220)
    exitButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    local exitCorner = Instance.new("UICorner", exitButton)
    exitCorner.CornerRadius = UDim.new(0, 4)

    -- Logo Button (for minimize)
    local logoButton = Instance.new("TextButton", screenGui)
    logoButton.Size = UDim2.new(0, 60, 0, 30)
    logoButton.Position = UDim2.new(0, 20, 0, 20)
    logoButton.Text = "GUI"
    logoButton.Font = Enum.Font.SourceSansBold
    logoButton.TextSize = 18
    logoButton.BackgroundColor3 = Color3.fromRGB(0, 170, 250)
    logoButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    logoButton.Visible = false
    local logoCorner = Instance.new("UICorner", logoButton)
    logoCorner.CornerRadius = UDim.new(0, 6)
    
    -- FOV CIRCLE (border-only, always on cursor)
    local fovFrame = Instance.new("Frame", screenGui)
    fovFrame.Size = UDim2.new(0, FOVRadius * 2, 0, FOVRadius * 2)
    fovFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    fovFrame.Position = UDim2.new(0, Mouse.X, 0, Mouse.Y)
    fovFrame.BackgroundTransparency = 1
    fovFrame.BorderSizePixel = 2
    fovFrame.BorderColor3 = Color3.fromRGB(0, 170, 250)
    fovFrame.Visible = true
    local fovCorner = Instance.new("UICorner", fovFrame)
    fovCorner.CornerRadius = UDim.new(1, 0)


    -- Minimize/restore/exit logic
    local function toggleMinimize()
        isMinimized = not isMinimized
        mainFrame.Visible = not isMinimized
        logoButton.Visible = isMinimized
        if fovFrame then fovFrame.Visible = not isMinimized and isActive end
    end
    minimizeButton.MouseButton1Click:Connect(toggleMinimize)
    logoButton.MouseButton1Click:Connect(toggleMinimize)

    local function cleanup()
        isActive = false
        if fovFrame then fovFrame:Destroy() fovFrame = nil end
        for _, player in pairs(Players:GetPlayers()) do
            if player.Character then
                for _, child in ipairs(player.Character:GetChildren()) do
                    if child:IsA("BillboardGui") and child.Name == "ESP_DOT" then
                        child:Destroy()
                    end
                end
            end
        end
        if screenGui then screenGui:Destroy() screenGui = nil end
    end
    exitButton.MouseButton1Click:Connect(cleanup)


    -- FOV Slider
    local fovLabel = Instance.new("TextLabel", mainFrame)
    fovLabel.Position = UDim2.new(0, 20, 0, 170)
    fovLabel.Size = UDim2.new(0, 140, 0, 25)
    fovLabel.Text = "FOV Radius: " .. tostring(FOVRadius)
    fovLabel.BackgroundTransparency = 1
    fovLabel.TextColor3 = Color3.fromRGB(170,170,255)
    fovLabel.TextScaled = true
    fovLabel.Font = Enum.Font.Gotham

    local fovSliderBG = Instance.new("Frame", mainFrame)
    fovSliderBG.Position = UDim2.new(0, 20, 0, 200)
    fovSliderBG.Size = UDim2.new(0, 140, 0, 12)
    fovSliderBG.BackgroundColor3 = Color3.fromRGB(55, 60, 80)
    fovSliderBG.BorderSizePixel = 0
    local fovSliderCorner = Instance.new("UICorner", fovSliderBG)
    fovSliderCorner.CornerRadius = UDim.new(1,0)

    local fovSliderBar = Instance.new("Frame", fovSliderBG)
    fovSliderBar.Size = UDim2.new((FOVRadius-40)/200, 0, 1, 0)
    fovSliderBar.BackgroundColor3 = Color3.fromRGB(0, 170, 250)
    fovSliderBar.BorderSizePixel = 0
    local fovSliderBarCorner = Instance.new("UICorner", fovSliderBar)
    fovSliderBarCorner.CornerRadius = UDim.new(1,0)

    -- Max Distance Slider
    local distLabel = Instance.new("TextLabel", mainFrame)
    distLabel.Position = UDim2.new(0, 20, 0, 225)
    distLabel.Size = UDim2.new(0, 140, 0, 25)
    distLabel.Text = "Max Distance: " .. tostring(MaxDetectionDistance)
    distLabel.BackgroundTransparency = 1
    distLabel.TextColor3 = Color3.fromRGB(170,255,170)
    distLabel.TextScaled = true
    distLabel.Font = Enum.Font.Gotham

    local distSliderBG = Instance.new("Frame", mainFrame)
    distSliderBG.Position = UDim2.new(0, 20, 0, 255)
    distSliderBG.Size = UDim2.new(0, 140, 0, 12)
    distSliderBG.BackgroundColor3 = Color3.fromRGB(55, 80, 60)
    distSliderBG.BorderSizePixel = 0
    local distSliderCorner = Instance.new("UICorner", distSliderBG)
    distSliderCorner.CornerRadius = UDim.new(1,0)

    local distSliderBar = Instance.new("Frame", distSliderBG)
    distSliderBar.Size = UDim2.new((MaxDetectionDistance-100)/4900, 0, 1, 0)
    distSliderBar.BackgroundColor3 = Color3.fromRGB(0, 255, 120)
    distSliderBar.BorderSizePixel = 0
    local distSliderBarCorner = Instance.new("UICorner", distSliderBar)
    distSliderBarCorner.CornerRadius = UDim.new(1,0)

    -- ESP Toggle
    local espButton = Instance.new("TextButton", mainFrame)
    espButton.Size = UDim2.new(0, 140, 0, 40)
    espButton.Position = UDim2.new(0, 20, 0, 35) -- Adjusted Y position
    espButton.Text = "ESP: ON"
    espButton.BackgroundColor3 = Color3.fromRGB(34, 38, 54)
    espButton.TextColor3 = Color3.fromRGB(0, 255, 120)
    espButton.TextScaled = true
    local espBtnCorner = Instance.new("UICorner", espButton)
    espBtnCorner.CornerRadius = UDim.new(0,6)

    -- Team Check Toggle
    local teamButton = Instance.new("TextButton", mainFrame)
    teamButton.Size = UDim2.new(0, 140, 0, 40)
    teamButton.Position = UDim2.new(0, 20, 0, 80) -- Adjusted Y position
    teamButton.Text = "Team Check: OFF"
    teamButton.BackgroundColor3 = Color3.fromRGB(34, 38, 54)
    teamButton.TextColor3 = Color3.fromRGB(255, 255, 120)
    teamButton.TextScaled = true
    local teamBtnCorner = Instance.new("UICorner", teamButton)
    teamBtnCorner.CornerRadius = UDim.new(0,6)

    -- Auto Snap Toggle
    local autoSnapButton = Instance.new("TextButton", mainFrame)
    autoSnapButton.Size = UDim2.new(0, 140, 0, 40)
    autoSnapButton.Position = UDim2.new(0, 20, 0, 125) -- Adjusted Y position
    autoSnapButton.Text = "Auto Snap: ON"
    autoSnapButton.BackgroundColor3 = Color3.fromRGB(34, 38, 54)
    autoSnapButton.TextColor3 = Color3.fromRGB(0, 255, 120)
    autoSnapButton.TextScaled = true
    local snapBtnCorner = Instance.new("UICorner", autoSnapButton)
    snapBtnCorner.CornerRadius = UDim.new(0,6)

    -- Aimbot Toggle (manual, only active if AutoSnap is off)
    local aimbotButton = Instance.new("TextButton", mainFrame)
    aimbotButton.Size = UDim2.new(0, 140, 0, 40)
    aimbotButton.Position = UDim2.new(0, 20, 0, 280) -- Adjusted Y position
    aimbotButton.Text = "Aimbot: OFF"
    aimbotButton.BackgroundColor3 = Color3.fromRGB(34, 38, 54)
    aimbotButton.TextColor3 = Color3.fromRGB(255, 100, 100)
    aimbotButton.TextScaled = true
    local aimBtnCorner = Instance.new("UICorner", aimbotButton)
    aimBtnCorner.CornerRadius = UDim.new(0,6)

    -- Button Toggles
    espButton.MouseButton1Click:Connect(function()
        ESPEnabled = not ESPEnabled
        espButton.Text = ESPEnabled and "ESP: ON" or "ESP: OFF"
        espButton.TextColor3 = ESPEnabled and Color3.fromRGB(0,255,120) or Color3.fromRGB(255,100,100)
    end)
    teamButton.MouseButton1Click:Connect(function()
        TeamCheck = not TeamCheck
        teamButton.Text = TeamCheck and "Team Check: ON" or "Team Check: OFF"
        teamButton.TextColor3 = TeamCheck and Color3.fromRGB(0,255,120) or Color3.fromRGB(255,255,120)
    end)
    autoSnapButton.MouseButton1Click:Connect(function()
        AutoSnap = not AutoSnap
        autoSnapButton.Text = AutoSnap and "Auto Snap: ON" or "Auto Snap: OFF"
        autoSnapButton.TextColor3 = AutoSnap and Color3.fromRGB(0,255,120) or Color3.fromRGB(255,100,100)
    end)
    aimbotButton.MouseButton1Click:Connect(function()
        AimbotEnabled = not AimbotEnabled
        aimbotButton.Text = AimbotEnabled and "Aimbot: ON" or "Aimbot: OFF"
        aimbotButton.TextColor3 = AimbotEnabled and Color3.fromRGB(0,255,120) or Color3.fromRGB(255,100,100)
    end)

    -- FOV Slider Logic
    local draggingFOV = false
    fovSliderBG.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            draggingFOV = true
        end
    end)
    fovSliderBG.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            draggingFOV = false
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if draggingFOV and input.UserInputType == Enum.UserInputType.MouseMovement then
            local relX = math.clamp((input.Position.X - fovSliderBG.AbsolutePosition.X) / fovSliderBG.AbsoluteSize.X, 0, 1)
            FOVRadius = math.floor(40 + relX * 200) -- Min 40, Max 240
            fovSliderBar.Size = UDim2.new((FOVRadius-40)/200, 0, 1, 0)
            fovLabel.Text = "FOV Radius: " .. tostring(FOVRadius)
        end
    end)

    -- Max Distance Slider Logic
    local draggingDist = false
    distSliderBG.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            draggingDist = true
        end
    end)
    distSliderBG.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            draggingDist = false
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if draggingDist and input.UserInputType == Enum.UserInputType.MouseMovement then
            local relX = math.clamp((input.Position.X - distSliderBG.AbsolutePosition.X) / distSliderBG.AbsoluteSize.X, 0, 1)
            MaxDetectionDistance = math.floor(100 + relX * 4900) -- Min 100, Max 5000
            distSliderBar.Size = UDim2.new((MaxDetectionDistance-100)/4900, 0, 1, 0)
            distLabel.Text = "Max Distance: " .. tostring(MaxDetectionDistance)
        end
    end)

    -- Team Check Helper
    local function isSameTeam(player)
        if LocalPlayer.Team and player.Team then
            return LocalPlayer.Team == player.Team
        end
        return false -- Default to not same team if teams are nil or different
    end

    local function inMaxDistance(targetPart)
        if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") or not targetPart then return false end
        return (LocalPlayer.Character.HumanoidRootPart.Position - targetPart.Position).Magnitude <= MaxDetectionDistance
    end

    -- DOT ESP
    local function createDotESP(player)
        local function setup()
            if player.Character and player.Character:FindFirstChild("Head") then
                if player.Character:FindFirstChild("ESP_DOT") then return end
                local billboard = Instance.new("BillboardGui")
                billboard.Name = "ESP_DOT"
                billboard.Size = UDim2.new(0, 7, 0, 7)
                billboard.Adornee = player.Character.Head
                billboard.AlwaysOnTop = true
                billboard.LightInfluence = 0
                billboard.Parent = player.Character

                local dot = Instance.new("Frame", billboard)
                dot.Size = UDim2.new(1, 0, 1, 0)
                dot.BackgroundColor3 = Color3.fromRGB(0, 255, 120) -- Default green
                dot.BackgroundTransparency = 0
                dot.BorderSizePixel = 0
                local dotCorner = Instance.new("UICorner", dot)
                dotCorner.CornerRadius = UDim.new(1, 0)
            end
        end
        if player.Character then
            setup()
        end
        player.CharacterAdded:Connect(function(character) -- Connect to new character
            task.wait(0.5) -- Wait for head to potentially load
            setup()
        end)
    end

    local function removeDotESP(player)
        if player.Character then
            local espDot = player.Character:FindFirstChild("ESP_DOT")
            if espDot then
                espDot:Destroy()
            end
        end
    end

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            createDotESP(player)
        end
    end
    Players.PlayerAdded:Connect(function(player)
        if player ~= LocalPlayer then
            createDotESP(player)
        end
    end)
    Players.PlayerRemoving:Connect(function(player)
        removeDotESP(player)
    end)

    -- Get Closest Target
    local function getClosestTarget()
        local closest = nil
        local shortestDistance = math.huge
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer
                and player.Character
                and player.Character:FindFirstChild("Humanoid")
                and player.Character.Humanoid.Health > 0
                and player.Character:FindFirstChild("Head")
                and player.Character:FindFirstChild("HumanoidRootPart")
            then
                if TeamCheck and isSameTeam(player) then
                    continue
                end
                if not inMaxDistance(player.Character.HumanoidRootPart) then
                    continue
                end
                local head = player.Character.Head
                local pos, onScreen = Camera:WorldToViewportPoint(head.Position)
                if onScreen then
                    local distance = (Vector2.new(Mouse.X, Mouse.Y) - Vector2.new(pos.X, pos.Y)).Magnitude
                    if distance < shortestDistance and distance < FOVRadius then
                        shortestDistance = distance
                        closest = head
                    end
                end
            end
        end
        return closest
    end

    -- MAIN LOOP: FOV CIRCLE POS, ESP, AIMBOT (TENGAH CROSSHAIR)
    RunService.RenderStepped:Connect(function()
        if not isActive or not screenGui or not screenGui.Parent then return end -- Check if GUI is still valid

        -- FOV CIRCLE
        if fovFrame and fovFrame.Parent then
             fovFrame.Position = UDim2.new(0, Mouse.X, 0, Mouse.Y)
             fovFrame.Size = UDim2.new(0, FOVRadius * 2, 0, FOVRadius * 2)
             fovFrame.Visible = not isMinimized
        end


        -- ESP Display (dot)
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer and player.Character then
                local esp = player.Character:FindFirstChild("ESP_DOT")
                if esp then
                    esp.Enabled = ESPEnabled and not isMinimized and isActive
                    -- Update dot color based on team (example, adjust colors as needed)
                    local dotFrame = esp:FindFirstChildWhichIsA("Frame")
                    if dotFrame then
                        if TeamCheck and isSameTeam(player) then
                            dotFrame.BackgroundColor3 = Color3.fromRGB(0, 150, 255) -- Friendly color
                        else
                            dotFrame.BackgroundColor3 = Color3.fromRGB(255, 60, 60)   -- Enemy color
                        end
                         if not inMaxDistance(player.Character:FindFirstChild("HumanoidRootPart")) then
                             esp.Enabled = false
                         end
                    end
                end
            end
        end

        -- Aimbot: HEAD PASTI DI TENGAH LAYAR
        if ((AutoSnap and AimbotEnabled) or (not AutoSnap and AimbotEnabled and UserInputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton2)))
            and not isMinimized and isActive then
            local target = getClosestTarget()
            if target and target.Parent then -- Ensure target is still valid
                local currentCFrame = Camera.CFrame
                local targetPosition = target.Position
                local newCFrame = CFrame.new(currentCFrame.Position, targetPosition)
                -- Smooth aim transition (optional, can be demanding)
                -- Camera.CFrame = currentCFrame:Lerp(newCFrame, 0.2) 
                Camera.CFrame = newCFrame -- Direct snap
            end
        end
    end)
end -- End of runArsenalScript function


-- EXECUTE KEY SYSTEM UI
createKeySystemUI()
